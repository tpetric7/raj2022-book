### Kurzgeschichten im Vergleich

In diesem Abschnitt vergleichen wir zwei Kurzgeschichten miteinander, und zwar:
- *Die Küchenuhr* von *Wolfgang Borchert* und   
- *Das Duell* von *Irmtraud Morgner*.   
Verglichen werden soll der Anteil der Pronomen und Substantive in beiden Texten.

Nach der Lektüre beider Texte haben wir den Eindruck, dass der Schreibstil unterschiedlich ist. Ein hervorstechendes Merkmal in Borcherts Kurzgeschichte ist der Gebrauch von Pronomen statt Substantiven bzw. Nominalphrasen mit substantivischem Kopf.   

*Null-Hypothese* ($H_0$): Der Anteil der Pronomen ist in beiden Kurzgeschichten ähnlich groß.
*alternative Hypothese* ($H_1$): Der Anteil der Pronomen in Borcherts Kurzgeschichte ist größer als in Morgners Kurzgeschichte.   

#### Programme laden

```{r message=FALSE, warning=FALSE}
library(tidyverse)
library(scales)
library(quanteda)
library(quanteda.textstats)
library(quanteda.textplots)
library(readtext)
```

#### Texte laden

```{r message=FALSE, warning=FALSE}
borchert <- read_lines("data/borchert/borchert_kuechenuhr.txt")
morgner <- read_lines("data/morgner/morgner_duell.txt")
```

#### Textzerlegung und Annotation

Die grammatische Analyse führen wir mit `udpipe` durch. Zuerst laden wir ein entsprechendes Sprachmodell.

```{r message=FALSE, warning=FALSE}
library(udpipe)
destfile = "german-gsd-ud-2.5-191206.udpipe"

if(!file.exists(destfile)){
   sprachmodell <- udpipe_download_model(language = "german")
   udmodel_de <- udpipe_load_model(sprachmodell$file_model)
   } else {
  file_model = destfile
  udmodel_de <- udpipe_load_model(file_model)
}

```

Das Programm `udpipe` annotiert den Text mit Hilfe des Sprachmodells.

```{r message=FALSE, warning=FALSE}
x <- udpipe_annotate(udmodel_de, x = borchert, trace = FALSE)
b <- as.data.frame(x) %>% 
  mutate(doc_id = "borchert_kuechenuhr")

x <- udpipe_annotate(udmodel_de, x = morgner, trace = FALSE)
m <- as.data.frame(x) %>% 
  mutate(doc_id = "morgner_duell")

```

Wir vereinen beide Datensätze in einem neuen Datensatz (*kurz*), und zwar mit Hilfe der Funktion `bind_rows()`.

```{r message=FALSE, warning=FALSE}
kurz <- bind_rows(b, m)
```

Nun sind wir bereits in der Lage, Wortklassen zu zählen, die `udpipe` identifiziert hat. Dazu verwenden wir die Funktion `count()`. Gezählt werden die Kategorien in der Spalte *xpos*.

```{r message=FALSE, warning=FALSE}
kurz %>% 
  group_by(doc_id) %>% 
  count(xpos, sort = TRUE)
```

Angesichts unserer oben angeführten Hypothese interessieren uns in der Spalte *xpos* nur die Kategorien *NN* (Nomen bzw. Substantive) und *PPER* (Personalpronomen). Deshalb filtern wir alle anderen Kategorien heraus. 

```{r message=FALSE, warning=FALSE}
tabelle_1 <- kurz %>% 
  group_by(doc_id) %>% 
  filter(xpos == "NN" | xpos == "PPER") %>% 
  count(xpos, sort = TRUE)
tabelle_1
```

Da Morgners Erzählung länger ist als Borcherts, fügen wir noch Prozentzahlen zur Tabelle hinzu. Dann fällt der Vergleich leichter. 

```{r message=FALSE, warning=FALSE}
tabelle_1 %>% 
  mutate(pct = n/sum(n))
```

Die Tabelle können wir umgestalten, so dass sie leichter zu lesen ist. Zu diesem Zweck setzen wir die Funktion `pivot_wider()` ein.

```{r message=FALSE, warning=FALSE}
tabelle_2 <- tabelle_1 %>% 
  mutate(Anteil = round(100*n/sum(n), 2)) %>% 
  rename(wortklasse = xpos) %>% 
  select(-n) %>% 
  pivot_wider(names_from = doc_id, values_from = Anteil)
tabelle_2
```


Das Ergebnis können wir auch graphisch darstellen.

```{r message=FALSE, warning=FALSE}
tabelle_1 %>% 
  mutate(pct = n/sum(n)) %>% 
  ggplot(aes(doc_id, pct, fill = xpos)) +
  geom_col()
```

Eine etwas schönere Graphik - zu Demonstrationszwecken (in diesem Fall ein Mordsaufwand, der an Overkill grenzt):

```{r message=FALSE, warning=FALSE}
library(ggtext)

tabelle_1 %>% 
  mutate(pct = n/sum(n)) %>% 
  ggplot(aes(doc_id, pct, fill = xpos)) +
  geom_col(alpha = 0.7, color = "black", 
           width = 0.9, position = "dodge") +
  # geom_label(aes(label = xpos), size = 5, hjust = 1) +
  scale_x_discrete(labels = c("Borchert: Die Küchenuhr", 
                              "Morgner: Das Duell")) +
  scale_y_continuous(
    labels = percent_format(accuracy = 1), breaks = seq(0, 1, 0.1),
    sec.axis = dup_axis(name = NULL)) + 
  scale_fill_discrete(type = c("#810080", "#00aeff"),
                      labels = c("Nomen", "Personalpronomen")) +
  coord_cartesian(expand = FALSE, clip = "off") +
  theme(legend.position = "top", 
        legend.background = element_rect(color = "black", 
                                       fill = "moccasin", 
                                       size = 0.5, 
                                       linetype = "dotted"), 
        legend.key.height = unit(.5, "lines"), 
        legend.key.width = unit(4, "lines"), 
        panel.background = element_rect(color = "black", 
                                       fill = "moccasin",
                                       size = 0.5, 
                                       linetype = "dotted"),  
        plot.margin = margin(10, 10, 5, 0), 
        plot.title = element_markdown(color = "#810080", 
                                      size = 14, hjust = 0.5),
        plot.title.position = "plot", # default: panel
        plot.subtitle = element_markdown(color = "#00aeaf",
                                         hjust = 0.5),
        plot.caption = element_markdown(),
        plot.caption.position = "plot", # default: panel
        plot.background = element_rect(color = "black", 
                                       fill = "moccasin", 
                                       size = 2, 
                                       linetype = "dotted")) +
  labs(x = "", y = "", 
       title = "Anteil der **Nomen** und **Personalpronomen** in Kurzgeschichten",
       subtitle = "**Wolfgang Borcherts _Küchenuhr_ im Vergleich zu Irmtraud Morgners _Duell_**", 
       fill = "Wortklassen: ", 
       caption = "Annotation mit *udpipe* in *R")
```

Zum Abschluss machen wir noch den Chi-Quadrat-Test, um unsere Hypothese zu überprüfen. Die Formel für die Berechnung des $\chi^2$-Wertes:

$$
\tilde{\chi}^2=\sum_{k=1}^{n}\frac{(Observed_k - Expected_k)^2}{Expected_k}
$$

Für den $\chi^2$-Quadrat-Test benötigen wir eine 2 x 2 - Kreuztabelle mit den beobachteten Werten in beiden Stichproben. Die erwarteten (theoretischen) Werte werden von der `chisq.test()`-Funktion berechnet.

```{r message=FALSE, warning=FALSE}
tabelle_3 <- tabelle_1 %>% 
  rename(wortklasse = xpos) %>% 
  pivot_wider(names_from = doc_id, values_from = n)
tabelle_3
```


Das Ergebnis (p = 0,0002) besagt, dass wir die Nullhypothese verwerfen und die alternative Hypothese akzeptieren können, denn p < 0,05. Der Anteil der Pronomen in Borcherts Kurzgeschichte ist mit statistischer Signifikanz größer als in Morgners Kurzgeschichte. 

```{r message=FALSE, warning=FALSE}
chires <- chisq.test(tabelle_3[,-1])
chires
```

Bei Bedarf kann man aus der oben gespeicherten Variable *chires* außer den beobachteten Häufigkeiten (hier: *obs*) auch die erwarteten Häufigkeiten (hier: *ex(p)*) ausgeben lassen. Letztere zeigen, welche Werte man bei Gültikgeit der Nullhypothese (also 50% Nomen- vs. 50% Pronomen-Anteil) erwarten könnte.

```{r}
obs <- as_tibble(chires$observed) %>% 
  # shorter column names
  rename(morgner_obs = morgner_duell, 
         borchert_obs = borchert_kuechenuhr)

ex <- as_tibble(round(chires$expected, 0)) %>% 
  # shorter column names
  rename(morgner_exp = morgner_duell, 
         borchert_exp = borchert_kuechenuhr)

# choose first column of tabelle_3 and bind it with the other columns
freqenzen <- bind_cols(tabelle_3[, 1], obs, ex) %>% 
  # rename the word classes
  mutate(wortklasse = ifelse(wortklasse == "NN", 
                             "Nomen", "Pers.Pronomen"))
freqenzen
```

:::rmdrobot
Wie beeinflusst die Verwendung von Personalpronomen das Textverständnis? Oder anders gefragt: Versteht der Textrezipient einen Text leichter, wenn der Textproduzent Personalpronomen statt Nomen verwendet werden?   
:::
