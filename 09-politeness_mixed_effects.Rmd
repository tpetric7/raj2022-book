#### Lineare Regression

Politeness data (B. Winter tutorial)

Programme laden

```{r message=FALSE, warning=FALSE}
library(tidyverse)

```


Datei laden

```{r message=FALSE, warning=FALSE}
# LOAD
rm(list=ls(all=TRUE)) # clear memory
polite <- read.csv("data/politeness_data.csv", dec=".")

```

Ansicht der Datenlage

```{r message=FALSE, warning=FALSE}
head(polite)
```

Variablen festlegen

```{r message=FALSE, warning=FALSE}
polite$frequency = as.numeric(polite$frequency)
polite$scenario = as.factor(polite$scenario)
polite$subject = as.factor(polite$subject)
polite$gender = as.factor(polite$gender)
polite$attitude = as.factor(polite$attitude)

```

Kontraste für den statistischen Test setzen

```{r message=FALSE, warning=FALSE}
# In this session we use contr. sum contrasts
options(contrasts=c('contr.sum', 'contr.poly'))
options("contrasts")
```

Kontraste zurücksetzen

```{r message=FALSE, warning=FALSE}
# To reset default settings run: 
options(contrasts=c('contr.treatment', 'contr.poly')) 
# (all afex functions should be unaffected by this)

# # Setting contrasts of chosen variables only
# contrasts(polite$attitude) <- contr.treatment(2, base = 1)
 
```

![plot of chunk unnamed-chunk-1](figure/unnamed-chunk-1-1.png)

```{r message=FALSE, warning=FALSE}
boxplot(frequency ~ attitude*gender, 
        col=c("red","green"), data = polite)
```

Bild speichern

```{r message=FALSE, warning=FALSE}
# 1. Open jpeg file
jpeg("pictures/politeness_boxplot.jpg", 
     width = 840, height = 535)
# 2. Create the plot
boxplot(frequency ~ attitude*gender, 
        col=c("red","green"), data = polite) 
# 3. Close the file
dev.off()
```

```{r message=FALSE, warning=FALSE}
# Open a pdf file
pdf("pictures/politeness_boxplot.pdf") 
# 2. Create a plot
boxplot(frequency ~ attitude*gender, 
        col=c("red","green"), data = polite) 
# Close the pdf file
dev.off() 
```


```{r message=FALSE, warning=FALSE}
# Inspect relationships between pairs of variables
# library(MASS)
```

Inspect relationships between pairs of variables

```{r message=FALSE, warning=FALSE}
library(psych)
pairs.panels(polite[c(2,4,5)])
```

Ordinary Least Squares Regression (OLS)

```{r message=FALSE, warning=FALSE}
# model 1
m <- lm(frequency ~ gender + attitude + subject + scenario, data = polite)
summary(m)
```


```{r message=FALSE, warning=FALSE}
# model 2
m <- lm(frequency ~ gender + attitude, data=polite)
summary(m)
```


```{r message=FALSE, warning=FALSE}
library(effects)
allEffects(m)
```


```{r message=FALSE, warning=FALSE}
plot(allEffects(m), multiline=TRUE, grid=TRUE, rug=FALSE, as.table=TRUE)
```

![plot of chunk unnamed-chunk-1](figure/unnamed-chunk-1-2.png)

```{r message=FALSE, warning=FALSE}
# Save plot of the effects to disk
# 1. Open jpeg file
jpeg("pictures/politeness_lineplot.jpg", 
     width = 840, height = 535)
# 2. Create the plot
plot(allEffects(m), multiline=TRUE, grid=TRUE, rug=FALSE, as.table=TRUE)
# 3. Close the file
dev.off()
```


```{r message=FALSE, warning=FALSE}
# model 3 (with interaction)
m <- lm(frequency ~ gender*attitude, data=polite)
summary(m)
```


```{r message=FALSE, warning=FALSE}
library(effects)
allEffects(m)
```


```{r message=FALSE, warning=FALSE}
plot(allEffects(m), multiline=TRUE, grid=TRUE, rug=FALSE, as.table=TRUE)
```

![plot of chunk unnamed-chunk-1](figure/unnamed-chunk-1-3.png)

```{r message=FALSE, warning=FALSE}
# Save plot of the effects to disk
# 1. Open jpeg file
jpeg("pictures/politeness_effects.jpg", 
     width = 840, height = 535)
# 2. Create the plot
plot(allEffects(m), multiline=TRUE, grid=TRUE, rug=FALSE, as.table=TRUE)
# 3. Close the file
dev.off()
```


```{r message=FALSE, warning=FALSE}
# Open a pdf file
pdf("pictures/politeness_effects.pdf") 
# 2. Create a plot
plot(allEffects(m), multiline=TRUE, grid=TRUE, rug=FALSE, as.table=TRUE)
# Close the pdf file
dev.off() 
```


```{r message=FALSE, warning=FALSE}
# plot diagnostic diagrams
par(mfrow = c(3,2))
plot(m, which = 1) # variance of residuals vs. fitted values?
plot(m, which = 2) # normal distributed residuals?
plot(m, which = 3) # variance of residuals standardized
plot(m, which = 4) # Cook's distance (outliers / influencing data points?)
plot(m, which = 5) # Leverage vs. standardized variance of residuals
plot(m, which = 6) # Cook's distance vs. Leverage
par(mfrow = c(1,1))

```

![plot of chunk unnamed-chunk-1](figure/unnamed-chunk-1-4.png)

```{r message=FALSE, warning=FALSE}
# Change of estimates if one datapoint is removed from the model
d <- dfbetas(m)
head(d) %>% as.data.frame %>% rmarkdown::paged_table()
```


```{r message=FALSE, warning=FALSE}
# plot the dfbetas (are there any outliers or data points with high influence?)
par(mfrow = c(1,3))
plot(d[,1], col = "orange")
plot(d[,2], col = "blue")
plot(d[,3], col = "purple")
par(mfrow = c(1,1))
```

![plot of chunk unnamed-chunk-1](figure/unnamed-chunk-1-5.png)

#### Regression mit gemischten Effekten
(Mixed effects Regression)

```{r message=FALSE, warning=FALSE}
# The variables 'subject' and 'scenario' have been chosen as random effects
library(afex)
```


```{r message=FALSE, warning=FALSE}
# random intercepts model
m <- lmer(frequency ~ gender + 
            (1|subject) + (1|scenario), 
          REML=F, data=polite)
m0 <- m
summary(m)
```


```{r message=FALSE, warning=FALSE}
m <- lmer(frequency ~ gender + attitude + 
          (1|subject) + (1|scenario), 
          REML=F, data=polite)
m1 <- m
summary(m)
```


```{r message=FALSE, warning=FALSE}
m <- lmer(frequency ~ gender*attitude + 
            (1|subject) + (1|scenario), 
          REML=F, data=polite)
m2 <- m
summary(m)
```

Vergleich der Modelle:

```{r message=FALSE, warning=FALSE}
anova(m0,m1,m2)
```


```{r message=FALSE, warning=FALSE}
# politeness affected pitch (χ2(1)=11.62, p=0.00065), 
# lowering it by about 19.7 Hz ± 5.6 (standard errors) 

# random slopes model
m <- lmer(frequency ~ gender + 
            (attitude + 1|subject) + (attitude + 1|scenario), 
          REML=F, data=polite)
```


```{r message=FALSE, warning=FALSE}
m00 <- m
summary(m)
```


```{r message=FALSE, warning=FALSE}
m <- lmer(frequency ~ gender + attitude + 
          (attitude + 1|subject) + (attitude + 1|scenario), 
          REML=F, data=polite)
```


```{r message=FALSE, warning=FALSE}
m01 <- m
summary(m)
```


```{r message=FALSE, warning=FALSE}
m <- lmer(frequency ~ gender + attitude + 
            (attitude + 1|subject), 
          REML=F, data=polite)
```


```{r message=FALSE, warning=FALSE}
library(effects)
allEffects(m)
```


```{r message=FALSE, warning=FALSE}
plot(allEffects(m), multiline=TRUE, grid=TRUE, rug=FALSE, as.table=TRUE)
```

![plot of chunk unnamed-chunk-1](figure/unnamed-chunk-1-6.png)

```{r message=FALSE, warning=FALSE}
m <- lmer(frequency ~ gender + attitude + 
            (attitude + 1|scenario), 
          REML=F, data=polite)
```


```{r message=FALSE, warning=FALSE}
library(effects)
allEffects(m)
```


```{r message=FALSE, warning=FALSE}
plot(allEffects(m), multiline=TRUE, grid=TRUE, rug=FALSE, as.table=TRUE)
```

![plot of chunk unnamed-chunk-1](figure/unnamed-chunk-1-7.png)

```{r message=FALSE, warning=FALSE}
m <- lmer(frequency ~ gender*attitude + 
            (attitude + 1|subject) + (attitude + 1|scenario), 
          REML=F, data=polite)
```


```{r message=FALSE, warning=FALSE}
m02 <- m
summary(m)
```

Vergleich der Modelle:

```{r message=FALSE, warning=FALSE}
anova(m00,m01,m02)
```


```{r message=FALSE, warning=FALSE}
library(lmerTest)
s <- step(m)
```


```{r message=FALSE, warning=FALSE}
s
```


```{r message=FALSE, warning=FALSE}
library(LMERConvenienceFunctions)

m <- lmer(frequency ~ gender + attitude + 
            (attitude + 1|subject) + (attitude + 1|scenario), 
          REML=F, data=polite)
```


```{r message=FALSE, warning=FALSE}
m01 <- m
summary(m)
```


```{r message=FALSE, warning=FALSE}
# Check model asumptions
mcp.fnc(m)
```

![plot of chunk unnamed-chunk-1](figure/unnamed-chunk-1-8.png)

```{r message=FALSE, warning=FALSE}
fligner.test(frequency ~ attitude, polite)
```


```{r message=FALSE, warning=FALSE}
fligner.test(frequency ~ gender, polite)
```


```{r message=FALSE, warning=FALSE}
shapiro.test(polite$frequency)
```


```{r message=FALSE, warning=FALSE}
which(is.na(polite$frequency)) 
```


```{r message=FALSE, warning=FALSE}
# delete NA from data frame in row 39
polite1 <- polite[-39,]

# Remove outliers
freqout <- romr.fnc(m, polite1, trim=2.5)
```


```{r message=FALSE, warning=FALSE}
freqout$n.removed
```


```{r message=FALSE, warning=FALSE}
freqout$percent.removed
```


```{r message=FALSE, warning=FALSE}
freqout <- freqout$data
attach(freqout)
```


```{r message=FALSE, warning=FALSE}
# update model
m <- lmer(frequency ~ gender + attitude + 
            (attitude + 1|subject) + (attitude + 1|scenario), 
          REML=F, data=freqout)
```


```{r message=FALSE, warning=FALSE}
m01 <- m
summary(m)
```


```{r message=FALSE, warning=FALSE}
# Re-Check model asumptions
mcp.fnc(m)
```

![plot of chunk unnamed-chunk-1](figure/unnamed-chunk-1-9.png)

```{r message=FALSE, warning=FALSE}
fligner.test(frequency ~ attitude, freqout)
```


```{r message=FALSE, warning=FALSE}
fligner.test(frequency ~ gender, freqout)
```


```{r message=FALSE, warning=FALSE}
shapiro.test(freqout$frequency)
```

